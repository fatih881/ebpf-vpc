#!/bin/bash
set -e

# Flush existing rules
iptables -F
iptables -X
iptables -Z

# Set default policies
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Allow loopback
iptables -A INPUT -i lo -j ACCEPT

# Allow established and related connections
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Allow SSH (required for debugging/packer)
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Allow ICMP (Ping) - useful for connectivity checks
iptables -A INPUT -p icmp -j ACCEPT

# CloudFlared and GitHub Actions are outbound-initiated typically.
# If they require specific inbound ports, they should be added here.
# For now, assuming outbound is sufficient (OUTPUT ACCEPT).

echo "Firewall locked down."
