---
- name: Disable Root SSH Login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    validate: 'sshd -t -f %s'
  notify: Restart sshd

- name: Configure Sudoers for CI Runner (fedora user)
  copy:
    dest: /etc/sudoers.d/ci-runner
    content: "fedora ALL=(ALL) NOPASSWD: ALL"
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Remove other sudoers configurations (optional security hardening)
  # Be careful not to lock ourselves out if we were relying on other files
  # For this specific image build, we assume 'fedora' is the only admin user needed.
  shell: rm -f /etc/sudoers.d/* && echo "fedora ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/ci-runner
  ignore_errors: yes

- name: Install Firewall Lockdown Script
  template:
    src: firewall-lockdown.sh.j2
    dest: /usr/local/bin/firewall-lockdown.sh
    mode: '0755'

- name: Install Firewall Lockdown Service
  template:
    src: firewall-lockdown.service.j2
    dest: /etc/systemd/system/firewall-lockdown.service
    mode: '0644'

- name: Enable Firewall Lockdown Service
  systemd:
    name: firewall-lockdown.service
    enabled: yes
    daemon_reload: yes

handlers:
  - name: Restart sshd
    service:
      name: sshd
      state: restarted
